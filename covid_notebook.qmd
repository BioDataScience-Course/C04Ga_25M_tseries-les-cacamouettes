---
title: "___"
author: "Abraham Romane, Dechèvres Florine, Desterke Margot, Viseur Zoé"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
editor: visual
lang: fr
---

<!--# Ceci est un commentaire. -->

<!--% Ceci est une consigne. Ne jamais modifier ni déplacer les consignes dans le document ! -->

<!--% Complétez le titre et le nom des auteurs (auteur1, auteur2, auteur3 et auteur 4) dans l'entête YAML.-->

## Introduction et but

<!--% Rédigez une courte introduction de 3 ou 5 phrases qui présente vos données. Ajoutez une phrase de but. Vous devez citer la bibliographie en utilisant le formatage Markdown ad hoc et en incluant votre référence au format bibtex dans le fichier references.bib. -->

De 2020 à 2022, la pandémie de Covid-19 a ébranlé le monde, forçant la population à limiter ses déplacements. Les données fournies par les rapports de mobilité [@google_covid19_mobility] présentent l'évolution de la mobilité durant cette période en Wallonie, et ce pour différents lieux. Nous nous intéresserons ici aux commerces et loisirs, alimentation et pharmacie, lieux de résidence, et lieux de travail.

Dans cette étude, nous tenterons de quantifier l'impact qu'a eu le Covid-19 sur les déplacements de personnes en Belgique, Wallonie, en comparant les années 2020 et 2021.

## Matériel et méthodes

<!--% Indiquez ici d'où viennent les données et aussi quel logiciel (et version) vous utilisez pour les analyses. Inspirez-vous des projets déjà réalisés. -->

Les données proviennent de Google : <https://www.google.com/covid19/mobility/>

De plus, elles sont accompagnées de descriptifs sous forme de deux rapports, chacun correspondant à une année, 2020 et 2021 : <https://www.gstatic.com/covid19/mobility/2020-11-13_BE_Wallonia_Mobility_Report_fr.pdf>

<https://www.gstatic.com/covid19/mobility/2021-11-26_BE_Wallonia_Mobility_Report_fr.pdf>

Ces données renferment des informations liées aux déplacements de la population wallone en Belgique, durant les années 2020 et 2021, période durant laquelle la pandémie du Covid-19 était d'actualité.

L'analyse est réalisée avec la SciViews Box 2025 dans Saturn Cloud (Linux), utilisant le logiciel R (r R.version.string). Le package {pastecs} version r packageVersion("pastecs") est utilisé pour étudier la série temporelle.

## Analyses

<!--% Lisez bien les éléments devant guider votre analyse proposée dans le README.-->

```{r setup, include=FALSE}
# Nécessaire pour les tests SDD, ne pas utiliser dans un "vrai" projet
if (!"tools:tests" %in% search())
  source(here::here("tests/tools_tests.R"), attach(NULL, name = "tools:tests"))
# Configuration de l'environnement
SciViews::R("ts")
```

```{r import}
covid <- read("data/mobility_wallonia.rds")
skimr::skim(covid)
```

Interprétation :

Notre jeu de données est composé de septs variables dont six numériques et une caractère. On retrouve deux valeurs manquantes.

```{r}
#rename variables
srename(covid, 
 shop_leisure = retail_and_recreation_percent_change_from_baseline,
 grocery_pharma = grocery_and_pharmacy_percent_change_from_baseline,
 parks = parks_percent_change_from_baseline,
 stations = transit_stations_percent_change_from_baseline,
workplaces =  workplaces_percent_change_from_baseline,
 residential = residential_percent_change_from_baseline) -> covid
```

Graphique d'auto-correlation

```{r correlation}

```

<!--% Ajoutez le nombre de chunks que vous souhaitez. Répartissez-vous le travail correctement. Structurez la section en partie avec des titres explicites de niveau trois.-->

## Analyse par variable :

Retenir les jours de la semaine :

```{r semaine}

# Copie de la série initiale sous une autre nom
covidw <- covid
# Calcul des jours de la semaine
covidw$weekdays <- weekdays(as.POSIXct(covidw$date))
# Les données du week-end sont remplacées par des valeurs manquantes
covidw[covidw$weekdays == "Saturday" | covidw$weekdays == "Sunday" , 2:7] <- NA 
```

Retenir les jours du week-end :

```{r weekend}
# Copie de la série initiale sous une autre nom
covidy <- covid
# Calcul des jours de la semaine
covidy$weekdays <- weekdays(as.POSIXct(covidy$date))
# Les données du week-end sont remplacées par des valeurs manquantes
covidy[covidy$weekdays == "Monday" | covidy$weekdays == "Tuesday" | covidy$weekdays == "Wednesday" | covidy$weekdays == "Thursday" | covidy$weekdays == "Friday", 2:7] <- NA 

# Aggrégation par moyenne des valeurs par semaine
# covidy_ts2 <- aggregate(covidy_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
```

### Commerces et loisirs

La variable commerces et loisirs correspond aux déplacements des habitants de la régions wallonne dans des lieux de loisirs tels que les restaurants, les cafés, les centres commerciaux, les parcs à thème, les musées, les bibliothèques et les cinémas. Nous allons analyser l'évolution des déplacement aux cours de deux années charnières de la période du covid : 2020 et 2021

#### Année 2021

```{r serie_shop_2020}
shop_ts <- ts (covid$shop_leisure, start = c(2020, 46),end = c(2020, 365), frequency = 365 )
plot (shop_ts)
```

Nous pouvons observer que la série comporte du bruit qui peut créer des problèmes dans les futures analyses. Nous tentons donc de séparer cette série pour les jours de la semaine et pour les week-end :

Séparation pour les jours de la semaine :

```{r ser20_shop_semaine}
covidw_ts <- ts (covidw$shop_leisure, start = c(2020, 46),end = c(2020, 365), frequency = 365 )
# Aggrégation par moyenne des valeurs par semaine
weekshop_2020 <- aggregate(covidw_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot (weekshop_2020)
```

Séparation pour les week-end :

```{r  ser20_shop_weekend}
covidy_ts <- ts (covidy$shop_leisure, start = c(2020, 46),end = c(2020, 365), frequency = 365 )
# Aggrégation par moyenne des valeurs par week-end
weekendshop_2020 <- aggregate(covidy_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot (weekendshop_2020)
```

Nous voyons que la sélection des jours de la semaine ou des jours du week-end a permis de réduire grandement le bruit et de mieux visualiser l'allure générale de la courbe de la série. Cependant, entre la semaine et le week-end, la série ne semble pas varier énormément, ce qui signifie que les déplacements pour les lieux de commerces et de loisirs ne varient pas beaucoup de la semaine au weekend. Nous pouvons donc nous poser la question de l'utilité réelle de séparer ces deux parties, ou de garder la série combinant la semaine et le week-end.

Réalisons des statistiques glissantes pour avoir la moyenne des différents intervale de temps le long de notre série :

```{r statslide_shop_20}
shop_sl <- stat.slide (time (shop_ts), shop_ts, deltat =1/12)
plot (shop_sl, stat = "mean", leg = TRUE)
```

```{r statslide_shopweek_20}
shop_week_sl <- stat.slide (time (weekshop_2020), weekshop_2020, deltat =1/12)
plot (shop_week_sl, stat = "mean", leg = TRUE)
```

```{r statslide_shopweekend_20}
shop_weekend_sl <- stat.slide (time (weekendshop_2020), weekendshop_2020, deltat =1/12)
plot (shop_weekend_sl, stat = "mean", leg = TRUE)
```

Nous pouvons voir qu'entre les différentes données filtrées pour une période de la semaine ou pas, les moyennes des variation de déplacement le long de l'axe temporel de la série ne varient pas grandement. En effet, la valeur moyenne du deuxième pic dans la série excluant la semaine est juste légèrement plus en dessous de 0 que celles des deux autres types de séries. Nous décidons donc de garder la suite de l'analyse avec la séries contenant toutes les données, de la semaine et du week-end, et de comparer cette série pour 2020 et 2021.

Test de l'autocorrelation :

```{r acf_shop_20}
acf (shop_ts)
```

Le graphique de la fonction d'autocorrelation ne présente pas de cycle, mais toutes barres sont significatives (au dessus de l'enveloppe de confiance à 95%) et positive, ce qui signifie qu'une tendance à l'augmentation domine le signal.

Il serait intéressant aussi, au vu de l'aspect général de notre graphique, de regarder si a série présence des tendances locales, différentes phases d'évolution à long terme, croissance et puis décroissance :

```{r shop20_localtrend}
shop20_local <- local.trend (shop_ts)
class (shop20_local)
```

Effectivement, comme nous l'avions anticipé, les sommes cumulées (ligne rouge) forment un U assez net et deux pics bien marqué de chaque côté de ce V. Nous avons donc présence de plusieurs phases dans cette série : une croissance, suivit d'une décroissance marquée, puis d'une croissance aussi marquée, et enfin une légère décroissance. 
Les points de ruptures correspondant à ces changement de phases sont environ : au 73e jour, au 146e jour, et au 292e jour jour, et un ralentissement au 328e jour. 
Si nous convertissons ces données de jours en mois : 
Il y a eu une augmentation des déplacement jusqu'en mi-mars (14 mars environ). 
- À partir de mi-mars, le taux de déplacement vers les commerces et lieux de loisirs chute drastiquement, jusque fin mai. 
- Puis, à partir de la fin du mois de mai jusqu'en mi-octobre, les déplacement vers les commerces et loisirs augmentent progressivement. 
- Après la mi-octobre, on observe une nouvelle baisse des déplacements, plus progressive, pour ensuite se stabiliser (et peut-être monter très légerement) à la fin novembre. 

```{r}
#chunk pour avoir les valeurs précises des jours correspondant aux ruptures dans la courbe de local trend (code aidé par ingtelligence artificielle, à ne pas prendre en compte pour la correction si pas autorisé, réalisé juste par simple curiosité et désir de rendre l'analyse plus solide)
localtrend <- shop20_local
time_trend <- time(localtrend)

# Dérivée Calcul de la dérivée, pour détecter les variations de tendances locales
d_trend <- diff(localtrend)

# Lissage de la dérivée (moyenne mobile) pour éliminer le bruit et éviter d'avoir trop de valeurs de ruptures, et garder que les principales
d_trend_smooth <- stats::filter(d_trend, rep(1/7, 7), sides = 2)

# Détection des changements de signe : <0 : décroissante, >0 : croissante. Les changements dans ces signes montrent donc le point de changement de phase dans la 
sign_change <- diff(sign(d_trend_smooth))
ruptures <- which(sign_change != 0) + 1

# Filtrage des ruptures trop proches (de nouveau pour ne garder que les points de ruptures les plus importants dans la série )
#min_gap <- 10
#ruptures_filt <- ruptures[c(TRUE, diff(ruptures) > min_gap)]

# Temps des ruptures 
rupture_times <- time_trend[ruptures_filt]
rupture_times
```

Vérifions tout de même la tendance générale de cette série en la décomposant : 

```{r}

```


### Lieux de travail

La variable Lieux de travail correspond aux déplacements de la population wallone, en Belgique, vers leur lieu de travail. Nous allons comparer ces déplacements pour l'année 2020 et 2021.

#### Année 2020

```{r serie_travail_2020}
ts_work <- ts(covid$workplaces, start = c(2020, 46), frequency = 366, end = c(2020, 365))
plot(ts_work, xlab = "Temps [mois]", ylab = "Déplacements", main = "Année 2020 - Déplacements vers le lieu de travail")
tsp(ts_work)
```

La série concernant les déplacements vers les lieux de travail présente beaucoup de bruit cela risque de rendre l'analyse difficile. Nous allons donc tenter de garder uniquement les jours de la semaine :

```{r agrega_2020}
# La série temporelle est créée (début le 15 février 2020 = 46e jour de l'année 2020)
covidw_ts <- ts(covidw$workplaces, start = c(2020, 46), frequency = 365,end = c(2020, 365))
# Aggrégation par moyenne des valeurs par semaine
covidwork_2020 <- aggregate(covidw_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(covidwork_2020, xlab = "Temps [mois]", ylab = "Déplacements", main = "Année 2020 - Déplacements vers le lieu de travail")
```

Nous voyons qu'en ne gardant que les jours de la semaine, le bruit de la série est réduit. Nous continuerons donc nos analyses sur les valeurs moyennes de déplacements au travail uniquement la semaine autant pour 2020 que 2021. Nous voyons que début 2020, les déplacements vers les lieux de travail ont chuté brutalement pour ensuite connaitre deux remontées progressives durant le printemps et jusqu'à la fin de l'été. Enfin, une rechute moins marquée que la première est observée vers la fin de l'été. Puis, les déplacements vers les lieux de travail réaugmente fin 2020. Ces différentes diminutions puis augmentations pourraient être des cycles.

```{r acf_travail_2020 }
acf(covidwork_2020, main = "Graphique d'autocorrélation 2020")
```

Ce graphique d'autocorrélation ne semble pas présenter de cycle. Par contre, les barres significatives au début, deux barres correspondant aux deux premiers décalages sont significatives ce qui pourrait se traduire par un effet mémoire sur le court terme. Les autres barres sont non significatives, il n'y aurait donc pas non plus de tendance générale.

Nous réalisons une décomposition de la série afin d'analyser cette dernière plus en détail :

```{r medianetravail_2020}
covidw2020 <- tsd(covidwork_2020, method = "median", order = 5, times = 1)
plot(covidw2020, stack = FALSE, resid = FALSE, col = 1:2, main = "Décomposition par médianes mobiles", ylab = "Série", xlab = "Temps [semaines]")
```

Le filtrage par médianes mobiles permet de résumer comment varient les déplacements au travail au cours des semaines de l'année 2020. Entre la première et la dixième semaine, c'est-à-dire, en début mars, les déplacements vers le travail chutent. Puis, à partir de la onzième semaine, les déplacements se remettent à augmenter pour ensuite connaitre un plateau entre la 21ème et la 27ème semaine. Juste après, il y a une augmentation et enfin, un nouveau lors des dernières de 2021.

```{r decompotravail_2020}
plot(covidw2020, xlab = "Temps [semaines]")
```

Les résidus semblent indiquer qu'il n'y a aucun cycle. De manière générale, lorsque l'on observe la composante filtrée, bien qu'au début de la série il y ait une diminution importante des fréquentations au travail, le reste de la série semble présenter une tendance générale croissante. Nous vérifions s'il existe une tendance générale significative :

```{r tendancetravail_2020}
mts_2020 <- tseries(covidw2020)
trend.test(mts_2020[,"filtered"])
```

La p-value étant inférieure au seuil \alpha de 5% pour la composante filtrée,nous rejetons H0 même si il y a des ex-aequo car la p-value est bien inférieur au seuil. Nous pouvons donc dire qu'il est plausible qu'une tendance générale existe. Cette tendance est croissante car la valeur de \rho est positive.

Étant donné que, dans la série générale, nous observons un pic vers le bas en début d'année, il serait intéressant de se concentrer sur cette période de l'année. En effet, se concentrer sur une période qui va de mi-février à juin est intéressant car la période ayant le plus impacté la population est le confinement qui débuta en mars 2020 et qui a duré plusieurs mois.

```{r travail2020_fevrier_juin}
work2020_window <-window(covidwork_2020, start = c(2020,1), end = c(2020, 20))
plot(work2020_window, ylab = "Déplacements", main =  "Entre février et juin", xlab = "Temps [semaines]")
```

Les déplacements entre février et juin semble aller à la baisse.

```{r decompo2020_fevrier_juin}
workwindow2020_decomp <- tsd(work2020_window, method = "median", order = 5, times = 1)
plot(workwindow2020_decomp, col = 1:3, xlab = "Temps [semaines]")
```

La composante filtrée semble présenter une tendance générale décroissante entre mi-février et fin juin. Par contre, les résidus ne semblent présenter que du bruit blanc.

```{r tendancetravail2020_fevrier_juin}
mts_windowwork2020 <- tseries(workwindow2020_decomp)
trend.test(mts_windowwork2020[,"filtered"])
```

La tendance générale est significative au seuil \alpha de 5% car la p-value est bien inférieure à ce seuil. IL y a encore une fois des ex-aequo donc la tendance générale décroissante est à prendre avec des pincettes. De plus, cette tendance est décroissante car \rho a une valeur négative.

Nous allons aussi nous intéresser à la deuxième partie de l'année de juin fin à décembre :

```{r travail2020_juin_decembre}
work2020_window2 <-window(covidwork_2020, start = c(2020,21), end = c(2020, 45))
plot(work2020_window2, ylab = "Déplacements", main = "Entre juin et décembre", xlab = "Temps [semaines]")
```

Les déplacements vers le travail entre fin juin et décembre 2020 semblent augmenter malgré une diminution vers le milieu de la série.

```{r decompo2020_juin_decembre}
workwindow22020_decomp <- tsd(work2020_window2, method = "average", order = 5, times = 3)
plot(workwindow22020_decomp, col = 1:3, xlab = "Temps [semaines]")
```

La composante filtrée semble montrer une tendance générale à la croissance, alors que les résidus semblent indiquer de potentiels cycles. Nous allons vérifier si la tendance générale est bien significative et croissante :

```{r tendancetravail2020_juin_decembre}
mts_windowwork22020 <- tseries(workwindow22020_decomp)
trend.test(mts_windowwork22020[,"filtered"])
```

La tendance générale est en effet croissante avec une valeur \rho positive et significative car la p-value est inférieure au seuil \alpha de 5%.

Vérifions si des cycles existent :

```{r resid2020_juin-decembre}
 covid_extract_2020jd <-extract(workwindow22020_decomp, components = "residuals")
plot(covid_extract_2020jd,ylab = "Résidus", xlab = "Temps [mois]")
spectrum(covid_extract_2020jd, spans = c(3,5), main = "Périodogramme lissé", ylab = "spectre", xlab = "Fréquence")
```

Les résidus ne présentent pas de cycle étant donné l'absence de pics.

Pour être certains que les séries ne présentent aucun cycles, nous décidons d'analyser la potentielle présence de cycle en tenant compte, à la fois des jours de semaine et de weekend :

La méthode des différences est employées pour éliminer la tendance tout en conservant les potentiels cycles.

```{r cycle_semaine_weekend_2020}
covid_ts20 <- ts(covid$workplaces, start = c(2020, 46), frequency = 366, end = c(2020, 365))
covidwhole2020 <- tsd(covid_ts20, method = "diff", lag = 3 , times = 1)
extract_whole_20 <- extract(covidwhole2020, components = "residuals")
plot(extract_whole_20)
spectrum(extract_whole_20, spans= c(3,5))
time(covid_ts20)
```

Deux cycles significatifs sont observés en 2020. Un pic à une fréquence de 50, ce qui signifie un cycle tous les 7,3 jours et un autre pic à une fréquence de 100 jours ce qui signifie un cycle tous les 3,65 jours.

####Année 2021

```{r agrega_2021}
# La série temporelle est créée (début le 1er janvier 2021)
covidw_ts21 <- ts(covidw$workplaces, start = c(2021, 1), frequency = 365,end = c(2021, 365))
# Aggrégation par moyenne des valeurs par semaine
covidwork_2021 <- aggregate(covidw_ts21, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(covidwork_2021, xlab = "Temps [mois]", ylab = "Déplacements", main = "Année 2021 - Déplacements vers le lieu de travail")
```

La série présente une chute des déplacements envers les lieux de travail début 2021. Puis, cela augmente progressivement jusqu'au début de l'été. Pour ensuite rechuter, moins fort que la première fois et après remonter vers la fin de l'été. Ensuite, une autre rechute, plus forte que la dernière apparaît pour ensuite remonter à la fin de l'année 2021.

```{r acf_travail_2021 }
acf(covidwork_2021, main = "Graphique d'autocorrélation 2021")
```

Ce graphique d'autocorrélation est très semblable à celui de 2020. Il ne semble pas non plus y avoir de cycles. De plus, uniquement les deuxième et troisième barres sont significatives ce qui pourrait se déduire par un effet miroir à court terme, comme 2020. Nous décomposons la série afin de l'analyser plus en détail :

```{r medianetravail_2021}
covidw2021 <- tsd(covidwork_2021, method = "median", order = 5, times = 1)
plot(covidw2021, stack = FALSE, resid = FALSE, col = 1:2, main = "Décomposition par médianes mobiles", ylab = "Série", xlab = "Temps [semaines]")
```

Cette décomposition possède des caractéristiques semblables à la série de 2020 car il y a d'abord une diminution, suivie d'une augmentation. Puis, un plateau suivi d'une autre augmentation plus légère, et enfin un plateau sur les vingt dernières semaines.

Nous convertissons notre série décomposée en un objet mts, puis, nous observons le graphique d'autocorrélation de la composante filtrée.

```{r decompotravail_2021}
plot(covidw2021)
```

Nous allons vérifier si il existe une tendance générale dans la série. par contre il ne semble pas y avoir de cycles.

```{r tendancetravail_2021}
mtsw_2021 <- tseries(covidw2021)
trend.test(mtsw_2021[,"filtered"])
```

La p value étant inférieur à \alpha au seuil de 5%, la tendance générale croissante est donc significative. Nous considérons la tendance comme significative malgré les ex-aequos car la valeur de p-value est bien inférieure au seuil.

```{r residtravail_2021}
 covid_extract_2021 <-extract(covidw2021, components = "residuals")
plot(covid_extract_2021, ylab = "Résidus", xlab = "Temps [mois]")
spectrum(covid_extract_2021, spans = c(3,5), main = "Périodogramme lissé", ylab = "spectre", xlab = "frequency")
```

Nous pouvons tirer les mêmes conclusions que pour 2020, aucun cycle n'est présent étant donné l'absence de pics nets.

Afin de comparer avec 2020, nous allons aussi analyser 2021 en deux périodes de 6 mois :

```{r travail2021_janvier_juin}
work2021_window <-window(covidwork_2021, start = c(2021,1), end = c(2021, 26))
plot(work2021_window, ylab = "Déplacements entre janvier et juin", xlab = "Temps [semaines]")
```

Il semble y avoir une nette diminution des déplacements au travail en début d'année avec une ré augmentation légère par la suite mais pas de cycles.

```{r decompo2021_janvier_juin}
workwindow2021_decomp <- tsd(work2021_window, method = "median", order = 5, times = 1)
plot(workwindow2021_decomp, col = 1:3)
```

La série filtrée suggère une diminution suivie d'une stabilisation. Les résidus ne présentent rien en particulier, si ce n'est du bruit.

```{r tendancetravail2021_janvier_juin}
mts_windowwork2021<- tseries(workwindow2021_decomp)
trend.test(mts_windowwork2021[,"filtered"])
```

La tendance générale n'est pas significative avec une p-value supérieure au seuil \alpha de 5% pour la période janvier à juin 2021.

Regardons maintenant pour la période de fin juin à décembre de 2021 :

```{r travail2021_juin_decembre}
work2021_window2 <-window(covidwork_2021, start = c(2021,27), end = c(2021, 52))
plot(work2021_window2, ylab = "Déplacements", xlab = "Temps [mois]", main = "Déplacements travail fin juin-décembre")
```

Ce graphique laisse penser que des cycles peuvent exister dans cette série.

```{r decompo_2021_juin_decembre}
workwindow2021jd_decomp <- tsd(work2021_window2, method = "average", order = 9, times = 1)
plot(workwindow2021jd_decomp, col = 1:3)
```

Selon la série filtrée, il semble y avoir une diminution. Les résidus semblent présenter des cycles.

```{r tendancetravail2021_juin_decembre}
mts_windowwork2021jd<- tseries(workwindow2021jd_decomp)
trend.test(mts_windowwork2021jd[,"filtered"])
```

La tendance générale est significative avec une p-value inférieure au seuil \alpha de 5% pour la période fin juin à décembre 2021. De plus, elle est décroissante car la valeur de \rho est négative.

```{r resid2021_juin_décembre}
 covid_extract_2021jd <-extract(workwindow2021jd_decomp, components = "residuals")
plot(covid_extract_2021jd, ylab = "Résidus", xlab = "Temps [mois]")
spectrum(covid_extract_2021jd, spans = c(3,5), main = "Périodogramme lissé", ylab = "spectre", xlab = "Fréquence")
```

Ce graphique ne présente pas de pic net, il n'y a donc pas de cycle entre juin et décembre 2021.

Pour être certains que les séries ne présentent aucun cycles, nous décidons d'analyser la potentielle présence de cycle en tenant compte, à la fois des jours de semaine et de weekend :

La méthode des différences est employées pour éliminer la tendance tout en conservant les potentiels cycles.

```{r cycle_semaine_weekend_2021}
covid_ts21 <- ts(covid$workplaces, start = c(2021, 1), frequency = 365,end = c(2021, 365))
covidwhole2021 <- tsd(covid_ts21, method = "diff", lag = 3 , times = 1)
time(covid_ts21)
extract_whole_21 <- extract(covidwhole2021, components = "residuals")
plot(extract_whole_21)
spectrum(extract_whole_21, spans= c(3,5))
```

Tout comme 2020, deux cycles significatifs sont observés en 2021. Un pic à une fréquence de 50, ce qui signifie un cycle tous les 7,3 jours et un autre pic à une fréquence de 100 jours ce qui signifie un cycle tous les 3,65 jours.

#### Comparaison lieux de travail 2020-2021

Si nous nous intéressons à l'année entière, tant 2020 que 2021, les deux séries présentent une tendance générale à l'augmentation et une absence de cycle. Concernant les périodes de début d'année, commençant mi-février pour 2020 et en janvier pour 2021 et se terminant fin juin : l'analyse suggère qu'il y a une tendance générale décroissante en 2020 et pas de tendance générale en 2021 et aucun cycle, que ce soit en 2020 ou 2021. Concernant la période entre fin juin et décembre : en 2020, il y aurait une tendance générale croissante et aucun cycle, alors qu'en 2021, il y a une tendance générale décroissante et toujours aucun cycle.

### Alimentation et pharmacies

La variable Alimentation et pharmacies correspond à l’évolution des déplacements de la population wallonne vers les commerces alimentaires et pharmacies. Ces déplacements sont essentiels et donc moins sensibles aux restrictions que d’autres types de mobilité. Nous analysons cette série pour les années 2020 et 2021.

#### Année 2020

```{r serie grocery_pharma2020}
grocery_pharma_ts <- ts(covid$grocery_pharma, start = c(2020, 46), frequency = 365, end = c(2020, 365))
plot(grocery_pharma_ts, ylab = "déplacement supermarchés et pharmacies", xlab = "temps [mois]", main = "Année 2020 - déplacement supermarchés et pharmacies")
```

Ce graphique représente l'évolution des déplacements vers les supermarchés et les pharmacies durant l'année 2020 en période de covid. On aperçoit une chute brutale de la série un peu avant le mois de mars. Ensuite, la série se stabilise autour d'une tendance négative, puis, elle remonte légèrement à la fin de l'année. On observe également un pic au début du mois de février.

```{r serie grocery_pharma2020 sep}
covidw_ts <- ts(covidw$grocery_pharma, start = c(2020, 46), frequency = 365,end = c(2020, 365))
# Aggrégation par moyenne des valeurs par semaine
covidw_gp_ts2 <- aggregate(covidw_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(covidw_gp_ts2)

covidy_ts <- ts(covidy$grocery_pharma, start = c(2020, 46), frequency = 365,end = c(2020, 365))
# Aggrégation par moyenne des valeurs par semaine
covidy_gp_ts2 <- aggregate(covidy_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(covidy_gp_ts2)

par(mfrow = c(1, 2), mar = c(4, 4, 3, 1))
plot(covidw_gp_ts2, ylab = "déplacement supermarchés et pharmacies", xlab = "temps [mois]", main = "Année 2020 - déplacement supermarchés et pharmacies semaine")
plot(covidy_gp_ts2, ylab = "déplacement supermarchés et pharmacies", xlab = "temps [mois]", main = "Année 2020 - déplacement supermarchés et pharmacies week-end")
```

Lorsque l'on compare la variable alimentation et pharmacies entre la semaine et le week-end, on remarque que les deux séries évoluent de manière similaire. De ce fait, nous pouvons continuer les analyses en ne séparant pas les jours de la semaine et les week-end. On observe une forte chute un peu avant le mois de mars. Ensuite, les deux séries remontent pour se stabiliser autour d'une tendance négative puis elles remontent légèrement à la fin de l'année 2020. Cela suggère que les gens vont à la pharmacie et vont chercher des aliments tant le week-end que la semaine. Le moment de la chute correspond au début des premières mesures sanitaires prises vis-à-vis de ces virus avant la confinement officiel. Cela pourrait être lié à une peur collective quant à la gravité de la situation.

#### Année 2021

```{r serie grocery_pharma2021}
grocery_pharma_ts2 <- ts(covid$grocery_pharma, start = c(2021, 1), frequency = 365, end = c(2021, 365))
plot(grocery_pharma_ts2, ylab = "déplacement supermarchés et pharmacies", xlab = "temps [mois]", main = "Année 2021 - déplacement supermarchés et pharmacies")
```

Ce graphique montre l'évolution des déplacements vers les supermarchés et les pharmacies durant l'année 2021 en période covid. Lorsque l'on observe de manière générale, nous apercevons trois pics : un autour du 12 janvier et deux autour du milieu du mois d'août. Quand on regarde l'évolution de la série, on voit une forte chute au milieu du mois de janvier qui pourrait correspondre aux mesures sanitaires plus strictes mises en place après les fêtes de fin d'années. Ensuite, la série remonte et elle se stabilise autour d'une tendance générale négative jusqu'en août où le deuxième et le troisième pics sont visibles pour après reprendre la tendance générale négative.

#### Comparaison année 2020 et année 2021

```{r serie grocery_pharma2020_2021}
grocery_pharma_ts <- ts(covid$grocery_pharma, start = c(2020, 46), frequency = 365, end = c(2020, 365))
plot(grocery_pharma_ts)

grocery_pharma_ts2 <- ts(covid$grocery_pharma, start = c(2021, 1), frequency = 365, end = c(2021, 365))
plot(grocery_pharma_ts2)


par(mfrow = c(1, 2), mar = c(4, 2.5, 3, 1))
plot(grocery_pharma_ts, ylab = "déplacement supermarchés et pharmacies", xlab = "temps [mois]", main = "Année 2020 - déplacement supermarchés et pharmacies")
plot(grocery_pharma_ts2, ylab = "déplacement supermarchés et pharmacies", xlab = "temps [mois]", main = "Année 2021 - déplacement supermarchés et pharmacies")

```

Lorsque l'on compare la forme générale de la série pour l'année 2020 et la série pour pour l'année 2021, l'aspect globale semble évoluer de manière similaire. En effet, même si la chute n'a pas lieu au même moment (2020 : février, 2021 : janvier), la baisse brutale de déplacement vers les supermarchés et les pharmacies est observable en début d'année dans les deux séries. Ensuite, tant pour 2020 que pour 2021, la série se stabilise autour d'une tendance générale pour, à la fin de l'année, remonter légèrement.

```{r autocorrélation2020gp}
acf(grocery_pharma_ts)
```

L’autocorrélation reflète principalement la persistance temporelle liée à la tendance et aux chocs successifs, plutôt qu’une véritable composante cyclique. Toutefois, on observe également une tendance générale négative. Les dernières valeurs sont à la marge de l'enveloppe de confiance de 95%.

Décomposons la série :

```{r decomp2020gp}
grocery_pharma_ts2020 <- tsd(grocery_pharma_ts, method = "average", type = "additive", order = 26, times = 3)
plot(grocery_pharma_ts2020, col = 1:3)
```

Au niveau de la série filtrée, on observe une tendance générale croissante sur l'année 2020. Dans les résidus, aucun cycle net est aperçu. Les résidus sont relativement centrés autour de zéro, avec quelques valeurs extrêmes.

Analysons la tendance générale :

```{r trend2020gp}
mts_grocerypharma_2020 <- tseries(grocery_pharma_ts2020)
acf(mts_grocerypharma_2020[, "filtered"])
trend.test(mts_grocerypharma_2020[, "filtered"])
```

La p-value du test de tendance est inférieure à 5 % (p-value = 2.2\^-16), ce qui conduit au rejet de l’hypothèse nulle. Il existe donc une tendance générale significative et croissante des déplacements vers les commerces alimentaires en 2020. La valeur du coefficient de tendance rho est positive et égale à 0,702, indiquant une tendance marquée.

Analysons les résidus :

```{r residuals2020gp}
grocerypharma_res_2020 <- extract(grocery_pharma_ts2020, components = "residuals")
plot(grocerypharma_res_2020)
spectrum(grocerypharma_res_2020, spans = c(3,5))
```

À partir du periodogramme lissé, nous pouvons observer que le spectre présente plusieurs maxima locaux. Plusieurs pics sont significatifs ce qui suggère un cycle régulier tous les 10, 50, 100, 140 et 160 jours.

#### Année 2021

```{r autocorrélation2021gp}
acf(grocery_pharma_ts2)
```

Comme pour l'autocorrélation de 2020, celle de 2021 reflète principalement la persistance temporelle liée à la tendance et aux chocs successifs, plutôt qu’une véritable composante cyclique. Toutefois, on observe également une tendance générale négative. Les dernières valeurs sont à la marge de l'enveloppe de confiance de 95%.

Décomposons la série :

```{r decomp2021gp}
grocery_pharma_ts2021 <- tsd(grocery_pharma_ts2, method = "average", type = "additive", order = 26, times = 3)
plot(grocery_pharma_ts2021, col = 1:3)
```

La composante filtrée semble indiquer une tendance générale légèrement croissante, moins prononcée qu’en 2020. Dans les résidus, aucun cycle net est aperçu. Les résidus sont relativement centrés autour de zéro, avec quelques valeurs extrêmes.

Analysons la tendance générale :

```{r trend2021gp}
mts_grocerypharma_2021 <- tseries(grocery_pharma_ts2021)
acf(mts_grocerypharma_2021[, "filtered"])
trend.test(mts_grocerypharma_2021[, "filtered"])
```

Comme pour la série 2020, dans celle de 2021 la p-value du test de tendance est inférieure à 5 % (p-value = 2.2\^-16), ce qui conduit au rejet de l’hypothèse nulle. Il existe donc une tendance générale significative et croissante des déplacements vers les commerces alimentaires en 2021. Cependant, la valeur du coefficient rho est plus faible (rho = 0,571), suggérant une tendance moins prononcée qu’en 2020.

```{r residuals2021gp}
grocerypharma_res_2021 <- extract(grocery_pharma_ts2021, compoenents = "residuals")
plot(grocerypharma_res_2021)
spectrum(grocerypharma_res_2021, spans = c(3,5))
```

Le periogramme montre que nous n'avons pas de cycle significatif dans la série.

#### Comparaison 2020 et 2021

En comparant les déplacements vers les supermarchés et les pharmacies entre 2020 et 2021, on observe des similitudes notables dans la dynamique générale. Dans les deux années, une forte baisse des déplacements est visible en début d’année, correspondant aux premières mesures sanitaires ou aux périodes de confinement, suivie d’une stabilisation autour d’une tendance négative, puis d’une légère reprise en fin d’année. Toutefois, la série de 2021 présente une tendance générale croissante moins marquée qu’en 2020, comme l’indique la valeur plus faible du coefficient de tendance (rho). Les résidus ne montrent pas de cycles nets significatifs pour 2021, alors que 2020 présentait quelques maxima locaux suggérant des variations régulières. Globalement, malgré des fluctuations ponctuelles différentes, le comportement des déplacements vers les commerces alimentaires et pharmacies reste relativement similaire d’une année à l’autre, reflétant la persistance de besoins essentiels malgré les restrictions sanitaires.

### Lieux de résidence

#### Année 2020

```{r serie_résid_2020}
res_20 <- ts(window(covid$residential, start = 1, end = 321),start = c(2020, 46), end = c(2020, 366), frequency = 366)
class(res_20)
```

Que ce soit pour le travail ou pour d'autres activités, la population quitte sa résidence globalement tous les jours de la semaine. Nous ne séparons donc pas les données entre jours de la semaine et jours de weekend. Jetons un oeil à cette série chronologique en imprimant son graphe.

```{r res20_plot}
plot(res_20, xlab = "Temps [mois]", ylab = "Evolution du nombre de personnes [%]", main = "Lieux de résidence - 2020")
tsp(res_20)
```

A cette étape, il est encore très difficile d'interpréter la série chronologique. Cependant, nous observons une brusque augmentation (+ 30%) de personnes restant chez elles début d'année 2020, illustrant l'arrivée soudaine de la quarantaine. On observe également une réduction de cette augmentation durant l'été. Le cycle semble à première vue saisonnier. Vérifions l'autocorrélation.

```{r acf_resid_2020}
acf(res_20, main = "Autocorrélation pour l'année 2020")
```

L'autocorrélation est forte. Toutes les barres sont significatives et positives. De plus, on distingue une décroissance, pouvant révéler une tendance générale à la diminution. Décomposons la série par les moyennes mobiles. L'amplitude des cycles semblant varier avec la tendance, nous utilisons un modèle multiplicatif.

```{r tsd_resid_2020}
res_20_dec <- tsd(res_20, method = "average", type = "additive", order = 30, times = 3)
plot(res_20_dec, xlab = "Temps [jours]", col = 1:3)
```

On observe une tendance générale à l'augmentation début d'année 2020, suivie d'une diminution en été, pour réaugmenter fin d'année. Les résidus indiquent la présence d'un cycle. Regardons chaque composante de plus près.

```{r mts_resid_2020}
res_20_mts <- tseries(res_20_dec)
class(res_20_mts)
colnames(res_20_mts)
plot(res_20_mts, main = "Composantes de la série - 2020", xlab = "Temps [mois]")
```

```{r acf_mts_20}
acf(res_20_mts[, "filtered"], main = "Autocorrélation de la tendance - 2020")
```

On observe bien une tendance significative à la diminution. Qu'en est-il des cycles ?

```{r resid_mts_20}
plot(res_20_mts[, "residuals"], ylab = "Composante résiduelle", xlab = "Temps [mois]")
```

La composante résiduelle étant stationnarisée, nous pouvons réaliser une analyse spectrale.

```{r spec20}
spectrum(res_20_mts[, "residuals"], spans = c(3, 5), main = "Analyse spectrale - 2020", ylab = "Spectre", xlab = "Fréquence")
```

On observe trois pics significatifs : à environ 1, 50 et 100 jours. Autrement dit, nous avons un cycle journalier, mensuel et bimestriel.

A cette étape, il est encore très difficile d'interpréter la série chronologique. Il y a beaucoup de bruit. Cependant, nous observons une brusque augmentation (+ 30%) de personnes restant chez elles début d'année 2020, illustrant l'arrivée soudaine de la quarantaine. On observe également une réduction de cette augmentation durant l'été. Vérifions l'autocorrélation.

```{r acf_2020}
acf(res_20, main = "Autocorrélation pour l'année 2020")
```

L'autocorrélation est forte. Toutes les barres sont significatives et positives. De plus, on distingue une décroissance, révélant une tendance générale à la diminution. Afin de diminuer le bruit, décomposons la série avec un filtrage par les valeurs propres, pour déterminer quelle composante a la plus forte variance.

```{r tsd_2020}
res_20_dec <- tsd(res_20, method = "evf", lag = 20, axes = 1)
plot(res_20_dec, xlab = "Temps [jours]", col = 1:3)
```

La série est dominée par une tendance. On observe une tendance générale à l'augmentation début d'année 2020, suivie d'une diminution en été, pour réaugmenter fin d'année. Analysons ces changements de tendance avec la méthode des sommes cumulées.

```{r}
res_20_lt <- local.trend(res_20, xlab = "Temps [mois]")
```

On observe bien deux phases principales : une augmentation à partir du mois d'avril, suivie d'une diminution à la transition juin-juillet. Une nouvelle augmentation est également observable début octobre.

#### Année 2021

```{r serie_2021}
res_21 <- ts(window(covid$residential, start = 322, end = 686),start = c(2021, 1), end = c(2021, 365), frequency = 366)
class(res_21)
```

Imprimons le graphe de cette série chronologique.

```{r res21_plot}
plot(res_21, xlab = "Temps [mois]", ylab = "Evolution du nombre de personnes [%]", main = "Lieux de résidence - 2021")
tsp(res_21)
```

Tout comme pour l'année 2020, on observe une forte augmentation de personnes restant chez elles en début d'année, et une augmentation réduite en été, mais il est encore trop tôt dans l'analyse pour de plus amples interprétations. Le cycle semble saisonnier. Vérifions l'autocorrélation.

```{r acf_2021}
acf(res_21, main = "Autocorrélation pour l'année 2021")
```

On observe une forte autocorrélation, avec des barres toutes positives et significatives. Une tendance à la diminution est également observable. Décomposons la série par les moyennes mobiles pour en savoir plus. Comme pour 2020, nous devons utiliser un modèle multiplicatif.

```{r tsd_2021}
res_21_dec <- tsd(res_21, method = "average", type = "additive", order = 30, times = 3)
plot(res_21_dec, col = 1:3, xlab = "Temps [jours]")
```

La tendance générale est identique à celle de 2020. Les résidus indiquent également la présence d'un cycle.

```{r mts_2021}
res_21_mts <- tseries(res_21_dec)
class(res_21_mts)
colnames(res_21_mts)
plot(res_21_mts, main = "Composantes de la série - 2021", xlab = "Temps [mois]")
```

```{r acf_mts_21}
acf(res_21_mts[, "filtered"], main = "Autocorrélation de la tendance - 2021")
```

```{r resid_mts_21}
plot(res_21_mts[, "residuals"], ylab = "Composante résiduelle", xlab = "Temps [mois]")
```

```{r spec21}
spectrum(res_21_mts[, "residuals"], spans = c(3, 5), main = "Analyse spectrale - 2021", ylab = "Spectre", xlab = "Fréquence")
```

Tout comme pour l'année 2020, on observe beaucoup de bruit. Une tendance à la diminution est observable, suivie d'une augmentation à partir du mois de septembre, mais il est encore trop tôt dans l'analyse pour de plus amples interprétations. Vérifions l'autocorrélation.

```{r acf_2021}
acf(res_21, main = "Autocorrélation pour l'année 2021")
```

On observe une autocorrélation, avec des barres toutes positives et significatives. Décomposons la série avec un filtrage par les valeurs propres pour réduire le bruit.

```{r tsd_2021}
res_21_dec <- tsd(res_21, method = "evf", lag = 20, axes = 1)
plot(res_21_dec, col = 1:3, xlab = "Temps [jours]")
```

Une tendance domine la série. La courbe montre une diminution, suivie d'une augmentation. Appliquons la méthode des sommes cumulées pour étudier ces changements de tendance.

```{r}
res_21_lt <- local.trend(res_21, xlab = "Temps [mois]")
```

La tendance locale à l'augmentation culmine vers le mois de mai, et une tendance locale à la diminution enchaîne directement, pour stagner en fin d'année.

#### Comparaison des années 2020 et 2021

Que ce soit pour 2020 ou 2021, on observe une nette autocorrélation, et une tendance domine la série chronologique.

Début du mois d'avril 2020, on observe une nette augmentation (+ 30%) du nombre de personnes restant chez elles : c'est le début de la quarantaine. Cette augmentation diminue ensuite à la transition juin-juillet pour atteindre son taux le plus bas en fin des vacances d'été, où les gens sortaient plus de chez eux pour profiter du beau temps, malgré la pandémie. Début octobre, la tendance remonte, illustrant la reprise des cours en ligne et du télétravail d'un grand pourcentage de la population.

L'année 2021 débute avec un taux d'augmentation d'environ 15%. Ce taux continue de grimper jusqu'à culminer vers le mois de mai, pour redescendre fortement ensuite, et atteindre un pallier fin 2021. Cette chute illustre l'allègement des mesures relatives à la pandémie, avec notamment la reprise totale des cours en présentiel pour les étudiants.

En résumé, l'année 2020 connut le plus grand taux d'augmentation du nombre de personnes restant dans leur lieu de résidence. En effet, l'année 2021 montra déjà une légère diminution par rapport à 2020, permise par les progrès médicaux et les premiers effets de l'immunité collective. De plus, la période estivale, accompagnée du beau temps, s'est avérée être la période avec le taux d'augmentation le plus faible, et ce pour les deux années.

# Conclusion

<!--% Lorsque toutes les analyses sont réalisées, terminez ce bloc-notes avec 3 à 6 phrases de conclusion en rapport avec ce que vous avez observé dans vos analyses. Quels sont les éléments les plus pertinents que vous retenez ? -->

...vos conclusions ici...
